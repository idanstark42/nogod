<!DOCTYPE html>
<html>
<head>
  <title>There is No God</title>
</head>
<style type="text/css">
  body {
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
  }
</style>
<body>
<div id="loader">
  <div id="loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">Loading...</div>
</div>
<div id="content" style="display: none; flex-direction: column; width: 100vw; height: 100vh; transition-property: background-color; transition-timing-function: linear;">
  <div id="main" style="position: relative; margin: auto;"></div>
  <div id="text" style="width: 100%; display: flex; align-items: center; justify-content: center; text-align: center;"></div>
</div>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script type="text/javascript">
const BASE_URL = 'https://script.google.com/macros/s/AKfycbw8-xV3nsPtiCBWkjEJgdkgNKO0Amyn5hzCcCjuHw-AMqZb8jzv0jUz7bQLbBDOBvwdyQ/exec'

let $main
let configuration

const init = async () => {
  $main = $('#main'), $text = $('#text'), $content = $('#content')
  const { events, config } = await fetch(`${BASE_URL}?action=load`).then(res => res.json())
  configuration = config
  initEvents(events, config)
  initConfig(config)

  $('#loader').fadeOut(500, () => {
    $('#content').fadeIn(500)
  })
}

const initEvents = (events, config) => {
  const animationDuration = config['animation duration (sec)']
  const animationDelay = config['animation delay (sec)']
  const textTime = config['text time (sec)']
  const mapHeight = config['map height (px)']
  $main[0].innerHTML = events.map(event => {
    if (!event['dot position x (%)'] || !event['dot position y (%)']) {
      return ''
    }

    const audio = event['audio file']
    const dotPosX = event['dot position x (%)'], dotPosY = event['dot position y (%)']
    const dotHeight = event['dot height (px)'] / mapHeight * 100, aspectRatio = event['dot width (px)'] / event['dot height (px)']
    const dotWidth = dotHeight * aspectRatio
    const iconCenterX = event['icon center x (px)'], iconCenterY = event['icon center y (px)'], iconWidth = event['icon width (px)'], iconHeight = event['icon height (px)']
    const imageWidth = event['image width (px)'], imageHeight = event['image height (px)']
    const text = event['text (split by newline)']
    const borderRadius = config['icons rounding (%)'] / 2

    return `
      <div referrerPolicy="no-referrer" style="position: absolute;
        left: calc(${dotPosX}% - ${dotWidth / 2}px); top: calc(${dotPosY}% - ${dotHeight / 2}px); aspect-ratio: ${aspectRatio}; height: ${dotHeight}%;
        background-size: ${imageWidth / iconWidth * 100}% ${imageHeight / iconHeight * 100}%;
        border-radius: ${borderRadius}%;
        background-repeat: no-repeat;
        transition-property: background-position, background-size, top, left, aspect-ratio, height, border-radius, opacity;
        transition-duration: ${animationDuration || 1}s;
        transition-timing-function: linear;
        transition-delay: ${animationDelay || 0}s;
        background-color: black;
        " title="${event['text story']}">
      </div>
    `
  }).join('')

  setTimeout(() => {
    const children = $main.children()
    events.forEach((event, i) => {
      event.$image = $main.find(`div[title="${event['text story']}"]`)
      fetch(`${BASE_URL}?action=get&filetype=image&filename=${event['image file']}`).then(res => res.text()).then(data => {
        event.$image.css({ backgroundImage: `url(${data})` })
      })
      event.$image.on('click', e => {
        // select correct event using the target
        const currentEvent = events.find(event => event.$image[0] === e.target)
        console.log(e, currentEvent)
        openImage(currentEvent, config)
        setTimeout(() => {
          startAudio(currentEvent, config)
          runText(currentEvent, config)
        }, (config['animation duration (sec)'] || 1) * 1000 * 3)
      })
    })
  }, 1000)
}

const initConfig = config => {
  const mapAspectRatio = config['map aspect ratio']
  const audioVolume = config['audio volume (%)']
  const mainBackgroundColor = config['main background color']
  const textAreaHeight = config['text area height (%)']
  const textAreaBackgroundColor = config['text area background color']
  const deadzoneBackgroundColor = config['deadzone background color']
  const textColor = config['text color']
  const textSize = config['text size (px)']

  $main.css({
    backgroundColor: mainBackgroundColor,
    aspectRatio: String(mapAspectRatio),
    height: `${textAreaHeight ? (100 - textAreaHeight) : 80}%`,
    transitionDuration: `${config['animation duration (sec)'] || 1}s`,
  })

  $text.css({
    height: `${textAreaHeight || 20}%`,
    color: textColor || 'black',
    fontSize: `${textSize || 20}px`,
    backgroundColor: textAreaBackgroundColor || 'white',
  })

  $content.css({ backgroundColor: deadzoneBackgroundColor })
}

const openImage = (event, config) => {
  $main.children().filter((i, el) => el !== event.$image[0]).css({ opacity: 0 })
  setTimeout(() => {
    const mapHeight = config['map height (px)']
    const iconCenterX = event['icon center x (px)'], iconCenterY = event['icon center y (px)'], iconWidth = event['icon width (px)'], iconHeight = event['icon height (px)'],
      dotHeight = event['dot height (px)'] / mapHeight * 100, aspectRatio = event['dot width (px)'] / event['dot height (px)'], dotWidth = dotHeight * aspectRatio,
      imageWidth = event['image width (px)'], imageHeight = event['image height (px)']
    event.$image.css({ top: iconCenterY - dotHeight / 2, left: iconCenterX - dotWidth / 2 })

    setTimeout(() => {
      const mainWidth = $main.width(), mainHeight = $main.height()
      event.$image.css({
        top: 0, left: `${(mainWidth - mainHeight * event['image width (px)'] / event['image height (px)']) / 2}px`,
        height: '100%', aspectRatio: `${event['image width (px)']/event['image height (px)']}`,
        backgroundSize: '100% 100%',
        borderRadius: 0
      })
    
      setTimeout(() => {
        $main.css({ backgroundColor: config['image background color'] })
      }, config['animation duration (sec)'] * 1000)
    }, config['animation duration (sec)'] * 1000)
  }, config['animation duration (sec)'] * 1000)
}

const closeImage = (event, config) => {
  const mapHeight = config['map height (px)']
  const dotPosX = event['dot position x (%)'], dotPosY = event['dot position y (%)']
  const iconCenterX = event['icon center x (px)'], iconCenterY = event['icon center y (px)'], iconWidth = event['icon width (px)'], iconHeight = event['icon height (px)'],
    dotHeight = event['dot height (px)'] / mapHeight * 100, aspectRatio = event['dot width (px)'] / event['dot height (px)'], dotWidth = dotHeight * aspectRatio,
    imageWidth = event['image width (px)'], imageHeight = event['image height (px)']

  $main.css({ backgroundColor: config['main background color'] })

  setTimeout(() => {
    // going back to the original size
    event.$image.css({
      top: iconCenterY - dotHeight / 2, left: iconCenterX - dotWidth / 2,
      aspectRatio: String(aspectRatio), height: `${dotHeight}%`,
      backgroundSize: `${imageWidth / iconWidth * 100}% ${imageHeight / iconHeight * 100}%`,
      borderRadius: config['icons rounding (%)'] / 2
    })

    setTimeout(() => {
      event.$image.css({
        left: `calc(${dotPosX}% - ${dotWidth / 2}px)`,
        top: `calc(${dotPosY}% - ${dotHeight / 2}px)`,
      })
    
      setTimeout(() => {
        $main.children().css({ opacity: 1 })
      }, config['animation duration (sec)'] * 1000)
    }, config['animation duration (sec)'] * 1000)
  }, config['animation duration (sec)'] * 1000)
}

const startAudio = (event, config) => {
  setTimeout(() =>{
    const audio = new Audio(event['audio file'])
    audio.volume = (config['audio volume (%)'] || 100) / 100
    audio.play()
  })
}

const runText = (event, config) => {
  const texts = event['text (split by newline)'].split('\n')
  let currentText = 0
  const next = () => {
    if (currentText < texts.length) {
      $text[0].innerHTML = texts[currentText++]
      setTimeout(next, (config['text time (sec)'] || 5) * 1000)
    } else {
      $text[0].innerHTML = ''
      closeImage(event, config)
    }
  }

  next()
}

$(document).ready(init)
</script>
</body>
</html>