<!DOCTYPE html>
<html>
<head>
  <title>No God</title>
</head>
<style type="text/css">
  body {
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
  }
</style>
<body>
<div id="loader">
  <div id="loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">Loading...</div>
</div>
<div id="content" style="display: none; flex-direction: column; width: 100vw; height: 100vh; transition-property: background-color; transition-timing-function: linear;">
  <div id="main" style="width: 100%; flex: 1; position: relative;"></div>
  <div id="text" style="width: 100%; display: flex; align-items: center; justify-content: center; text-align: center;"></div>
</div>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script type="text/javascript">
const LOAD_URL = 'https://script.google.com/macros/s/AKfycbzCa5qoxCtpCi7gslu45M7Be_aNlbT-FS83JVfpDkLRmn7tOWsi8k5IxAkTlUrBpJwPGw/exec?action=load'

let $main
let configuration

const init = async () => {
  $main = $('#main'), $text = $('#text')
  const { events, config } = await fetch(LOAD_URL).then(res => res.json())
  configuration = config
  initEvents(events, config)
  initConfig(config)

  $('#loader').fadeOut(500, () => {
    $('#content').fadeIn(500).css('display', 'flex')
  })
}

const initEvents = (events, config) => {
  const animationDuration = config['animation duration (sec)']
  const animationDelay = config['animation delay (sec)']
  const textTime = config['text time (sec)']
  $main[0].innerHTML = events.map(event => {
    const image = event['image file']
    const audio = event['audio file']
    const dotPosX = event['dot position x (%)'], dotPosY = event['dot position y (%)'], dotWidth = event['dot width (px)'], dotHeight = event['dot height (px)']
    const iconCenterX = event['icon center x (px)'], iconCenterY = event['icon center y (px)'], iconWidth = event['icon width (px)'], iconHeight = event['icon height (px)']
    const imageWidth = event['image width (px)'], imageHeight = event['image height (px)']
    const text = event['text (split by newline)']

    return `
      <div referrerPolicy="no-referrer" style="position: absolute;
        left: calc(${dotPosX}% - ${iconWidth / 2}px); bottom: calc(${dotPosY}% - ${iconHeight / 2}px); aspect-ratio: ${iconWidth / iconHeight}; height: ${iconHeight}px;
        background-image: url(${image});
        background-size: ${imageWidth / iconWidth * 100}% ${imageHeight / iconHeight * 100}%;
        background-position: calc(${iconCenterX}px - ${dotWidth / 2}px) calc(${iconCenterY}px - ${dotHeight / 2}px);
        background-repeat: no-repeat;
        transition-property: background-position, background-size, bottom, left, aspect-ratio, height;
        transition-duration: ${animationDuration || 1}s;
        transition-timing-function: linear;
        transition-delay: ${animationDelay || 0}s;
        "> 
      </div>
    `
  }).join('')

  setTimeout(() => {
    const children = $main.children()
    events.forEach((event, i) => {
      event.$image = $(children[i])
      console.log(event)
      event.$image.on('click', () => {
        openImage(event, config)
        setTimeout(() => {
          startAudio(event, config)

          const texts = event['text (split by newline)'].split('\n')
          let currentText = 0
          const next = () => {
            if (currentText < texts.length) {
              $text[0].innerHTML = texts[currentText++]
              setTimeout(next, (config['text time (sec)'] || 5) * 1000)
            } else {
              $text[0].innerHTML = ''
              closeImage(event, config)
            }
          }

          next()
        }, (config['animation duration (sec)'] || 1) * 1000)
      })
    })
  }, 1000)
}

const initConfig = config => {
  const audioVolume = config['audio volume (%)']
  const mainBackgroundColor = config['main background color']
  const textAreaHeight = config['text area height (%)']
  const textAreaBackgroundColor = config['text area background color']
  const textColor = config['text color']
  const textSize = config['text size (px)']

  $main.css({
    backgroundColor: mainBackgroundColor,
    transitionDuration: `${config['animation duration (sec)'] || 1}s`,
  })

  $text.css({
    height: `${textAreaHeight || 20}%`,
    color: textColor || 'black',
    fontSize: `${textSize || 20}px`,
    backgroundColor: textAreaBackgroundColor || 'white',
  })
}

const openImage = (event, config) => {
  $main.css({ backgroundColor: config['image background color'] })
  const mainWidth = $main.width(), mainHeight = $main.height()
  event.$image.css({ bottom: 0, left: `${(mainWidth - mainHeight * event['image width (px)'] / event['image height (px)']) / 2}px`, height: '100%', aspectRatio: `${event['image width (px)']/event['image height (px)']}`, backgroundPosition: 'center', backgroundSize: '100% 100%' })
}

const closeImage = (event, config) => {
  const dotPosX = event['dot position x (%)'], dotPosY = event['dot position y (%)'], dotWidth = event['dot width (px)'], dotHeight = event['dot height (px)']
  const iconCenterX = event['icon center x (px)'], iconCenterY = event['icon center y (px)'], iconWidth = event['icon width (px)'], iconHeight = event['icon height (px)']
  const imageWidth = event['image width (px)'], imageHeight = event['image height (px)']

  $main.css({ backgroundColor: config['main background color'] })
  event.$image.css({
    left: `calc(${dotPosX}% - ${iconWidth / 2}px)`,
    bottom: `calc(${dotPosY}% - ${iconHeight / 2}px)`,
    aspectRatio: `${iconWidth / iconHeight}`,
    height: `${iconHeight}px`,
    backgroundSize: `${imageWidth / iconWidth * 100}% ${imageHeight / iconHeight * 100}%`,
    backgroundPosition: `calc(${iconCenterX}px - ${dotWidth / 2}px) calc(${iconCenterY}px - ${dotHeight / 2}px)`
  })
}

const startAudio = (event, config) => {
  setTimeout(() =>{
    const audio = new Audio(event['audio file'])
    audio.volume = (config['audio volume (%)'] || 100) / 100
    audio.play()
  })
}

$(document).ready(init)
</script>
</body>
</html>